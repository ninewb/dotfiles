#!/usr/bin/env bash
set -euo pipefail

# -------------------------
# Kubernetes
# -------------------------

k8s_section() {
  if ! command -v kubectl >/dev/null 2>&1; then
    return
  fi

  local ctx
  ctx="$(kubectl config current-context 2>/dev/null || true)"
  [[ -n "$ctx" ]] || return

  local ns
  ns="$(kubectl config view --minify --output 'jsonpath={..namespace}' 2>/dev/null || true)"
  [[ -n "$ns" ]] || ns="default"

  printf " k8s:%s::%s " "$ctx" "$ns"
}

# -------------------------
# Git
# -------------------------

git_section() {
  local dir
  dir="$(tmux display-message -p "#{pane_current_path}" 2>/dev/null || pwd)"

  if ! git -C "$dir" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    return
  fi

  local branch
  branch="$(git -C "$dir" branch --show-current 2>/dev/null || true)"
  [[ -n "$branch" ]] || branch="detached"

  local dirty=""
  if ! git -C "$dir" diff --quiet 2>/dev/null || \
     ! git -C "$dir" diff --cached --quiet 2>/dev/null; then
    dirty="*"
  fi

  printf " git:%s%s " "$branch" "$dirty"
}

# -------------------------
# Output
# -------------------------

printf "%s%s" "$(k8s_section)" "$(git_section)"