#!/usr/bin/env bash
# shellcheck disable=SC2155,SC1091
set -euo pipefail

# ==============================================================================
# Dotfiles bootstrap (Linux + macOS)
#
# Goals (minimal, fast, and reproducible):
#   - alacritty
#   - neovim
#   - tmux
#   - 1password-cli (op)
#   - kubectl
#   - cargo (rustup)
#   - stow
#   - zsh
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/ninewb/dotfiles/main/setup | bash
#
# Optional env vars:
#   DOTFILES_REPO   (default: https://github.com/ninewb/dotfiles.git)
#   DOTFILES_DIR    (default: $HOME/.local/src/dotfiles)
#   STOW_PACKAGES   (default: "bin git neovim tmux zsh")
#   DO_STOW         (default: 1)  set to 0 to skip stow
#   INSTALL_GUI     (default: 1)  set to 0 to skip GUI apps (e.g., Alacritty on mac)
#   INSTALL_1PW      (default: 1) set to 0 to skip 1Password CLI
#   INSTALL_KUBECTL  (default: 1) set to 0 to skip kubectl
#   INSTALL_RUST     (default: 1) set to 0 to skip rustup/cargo
# ============================================================================== 

# -------- Pretty output --------
_hr() { printf '%*s\n' "${COLUMNS:-80}" '' | tr ' ' 'â”€'; }
_h() { printf "\n%s\n" "$( _hr )"; printf "%s\n" "$1"; printf "%s\n" "$( _hr )"; }

# -------- OS detection --------
OS="$(uname -s)"
ARCH="$(uname -m)"
IS_DARWIN=0
IS_LINUX=0
case "$OS" in
  Darwin) IS_DARWIN=1 ;;
  Linux)  IS_LINUX=1 ;;
  *) echo "Unsupported OS: $OS" >&2; exit 1 ;;
 esac

# -------- Defaults --------
: "${DOTFILES_REPO:=https://github.com/ninewb/dotfiles.git}"
: "${DOTFILES_DIR:=$HOME/.local/src/dotfiles}"
: "${STOW_PACKAGES:=bin git neovim tmux zsh}"
: "${DO_STOW:=1}"
: "${INSTALL_GUI:=1}"
: "${INSTALL_1PW:=1}"
: "${INSTALL_KUBECTL:=1}"
: "${INSTALL_RUST:=1}"

# -------- Helpers --------
has() { command -v "$1" >/dev/null 2>&1; }
need_cmd() { has "$1" || { echo "Missing required command: $1" >&2; return 1; }; }

# macOS brew path (Apple Silicon uses /opt/homebrew)
ensure_brew_in_path() {
  if [[ $IS_DARWIN -eq 1 ]]; then
    if [[ -x /opt/homebrew/bin/brew ]]; then
      eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -x /usr/local/bin/brew ]]; then
      eval "$(/usr/local/bin/brew shellenv)"
    fi
  fi
}

# -------- Package installation --------
install_macos_packages() {
  _h "macOS: installing packages (Homebrew)"

  if ! has brew; then
    echo "Homebrew not found. Installing..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi
  ensure_brew_in_path

  # CLI essentials
  brew update
  brew install \
    git \
    stow \
    neovim \
    tmux \
    zsh \
    jq \
    fzf \
    python

  if [[ "$INSTALL_1PW" == "1" ]]; then
    brew install 1password-cli
  fi

  if [[ "$INSTALL_KUBECTL" == "1" ]]; then
    brew install kubectl
  fi

  if [[ "$INSTALL_GUI" == "1" ]]; then
    # GUI apps are installed via casks
    brew install --cask alacritty
  fi
}

install_linux_packages() {
  _h "Linux: installing packages (apt)"

  # Prefer Ubuntu/Debian apt-based flows.
  need_cmd apt-get

  sudo apt-get update -y
  sudo apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    git \
    gnupg \
    jq \
    locales \
    stow \
    tmux \
    neovim \
    zsh \
    fzf \
    python3 \
    python3-pip

  # Alacritty availability varies by distro; try apt first.
  if [[ "$INSTALL_GUI" == "1" ]]; then
    if ! dpkg -s alacritty >/dev/null 2>&1; then
      sudo apt-get install -y alacritty || true
    fi
  fi

  if [[ "$INSTALL_1PW" == "1" ]]; then
    if ! has op; then
      _h "Linux: installing 1Password CLI (op)"
      # 1Password official repo install (Debian/Ubuntu)
      sudo mkdir -p /etc/apt/keyrings
      curl -fsSL https://downloads.1password.com/linux/keys/1password.asc \
        | sudo gpg --dearmor --yes -o /etc/apt/keyrings/1password-archive-keyring.gpg

      # Determine codename (fallback to jammy)
      local codename=""
      codename="$(. /etc/os-release && echo "${VERSION_CODENAME:-}")"
      if [[ -z "$codename" ]]; then codename="jammy"; fi

      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" \
        | sudo tee /etc/apt/sources.list.d/1password.list >/dev/null

      sudo apt-get update -y
      sudo apt-get install -y 1password-cli
    fi
  fi

  if [[ "$INSTALL_KUBECTL" == "1" ]]; then
    _h "Linux: ensuring kubectl"
    if ! has kubectl; then
      # Install latest stable kubectl
      local ver
      ver="$(curl -fsSL https://dl.k8s.io/release/stable.txt)"
      curl -fsSLO "https://dl.k8s.io/release/${ver}/bin/linux/amd64/kubectl"
      sudo install -m 0755 kubectl /usr/local/bin/kubectl
      rm -f kubectl
    fi
  fi
}

# -------- Rust / Cargo --------
install_rustup() {
  [[ "$INSTALL_RUST" == "1" ]] || return 0

  _h "Installing Rust (rustup/cargo)"

  if has cargo; then
    echo "cargo already present: $(command -v cargo)"
    return 0
  fi

  # rustup installs into ~/.cargo and ~/.rustup by default
  curl -fsSL https://sh.rustup.rs | sh -s -- -y --profile default --default-toolchain stable

  # Ensure current shell sees cargo for the rest of the script
  export PATH="$HOME/.cargo/bin:$PATH"
}

# -------- Zsh as default shell --------
ensure_zsh_default_shell() {
  _h "Ensuring zsh is the default shell"

  if ! has zsh; then
    echo "zsh not installed; skipping default shell change." >&2
    return 0
  fi

  # macOS: chsh is fine; Linux: may require sudo depending on environment
  local zsh_path="$(command -v zsh)"

  # Ensure zsh is listed in /etc/shells on Linux
  if [[ $IS_LINUX -eq 1 ]]; then
    if ! grep -qx "$zsh_path" /etc/shells; then
      echo "$zsh_path" | sudo tee -a /etc/shells >/dev/null
    fi
  fi

  if [[ "${SHELL:-}" != "$zsh_path" ]]; then
    echo "Changing default shell to: $zsh_path"
    chsh -s "$zsh_path" || true
  fi
}

# -------- Dotfiles clone + stow --------
setup_dotfiles() {
  _h "Cloning dotfiles"

  mkdir -p "$(dirname "$DOTFILES_DIR")"

  if [[ -d "$DOTFILES_DIR/.git" ]]; then
    echo "Dotfiles already cloned: $DOTFILES_DIR"
  else
    git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
  fi

  if [[ "$DO_STOW" == "1" ]]; then
    _h "Stowing packages: $STOW_PACKAGES"
    ( cd "$DOTFILES_DIR" && stow $STOW_PACKAGES -t "$HOME" )
  else
    echo "Skipping stow (DO_STOW=0)"
  fi

  # Ensure ZDOTDIR is consistent with your repo expectation
  # Only add if not already present
  local zshenv=""
  if [[ $IS_DARWIN -eq 1 ]]; then
    zshenv="$HOME/.zshenv"
  else
    # System zshenv is common on Linux; keep user-scoped and non-root
    zshenv="$HOME/.zshenv"
  fi

  if [[ ! -f "$zshenv" ]] || ! grep -q 'export ZDOTDIR=' "$zshenv"; then
    echo 'export ZDOTDIR="$HOME"/.config/zsh' >> "$zshenv"
  fi
}

# -------- Alacritty config sanity --------
post_checks() {
  _h "Post-install checks"

  echo "OS: $OS ($ARCH)"

  for c in git stow nvim tmux zsh python3 pip3; do
    if has "$c"; then
      echo "OK: $c -> $(command -v "$c")"
    else
      echo "MISSING: $c" >&2
    fi
  done

  if [[ "$INSTALL_1PW" == "1" ]]; then
    if has op; then
      echo "OK: op -> $(command -v op)"
      echo "Note: run 'op signin' manually to authenticate."
    else
      echo "MISSING: op (1Password CLI)" >&2
    fi
  fi

  if [[ "$INSTALL_KUBECTL" == "1" ]]; then
    if has kubectl; then
      echo "OK: kubectl -> $(command -v kubectl)"
    else
      echo "MISSING: kubectl" >&2
    fi
  fi

  if [[ "$INSTALL_RUST" == "1" ]]; then
    if has cargo; then
      echo "OK: cargo -> $(command -v cargo)"
    else
      echo "MISSING: cargo" >&2
    fi
  fi

  if [[ "$INSTALL_GUI" == "1" ]]; then
    if has alacritty; then
      echo "OK: alacritty -> $(command -v alacritty)"
    else
      echo "Note: alacritty may be installed as a GUI app and not on PATH on macOS."
    fi
  fi

  echo
  echo "Next steps:"
  echo "  1) Open a new terminal session (zsh)"
  echo "  2) (Optional) Authenticate 1Password: op signin"
  echo "  3) (Optional) Configure kubectl access (kubeconfig)"
}

main() {
  _h "Bootstrapping terminal environment"

  if [[ $IS_DARWIN -eq 1 ]]; then
    install_macos_packages
  else
    install_linux_packages
  fi

  install_rustup
  setup_dotfiles
  ensure_zsh_default_shell
  post_checks
}

main "$@"